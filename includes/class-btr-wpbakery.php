<?phpdefined('ABSPATH') || exit;class BTR_WPBakery_Modules {    public function __construct() {        add_action('vc_before_init', [$this, 'register_pacchetto_singolo_module']);        add_shortcode('btr_pacchetto_singolo', [$this, 'render_pacchetto_singolo']);        add_action('wp_ajax_btr_get_date_options', [$this, 'ajax_get_date_options']);        add_action('wp_ajax_nopriv_btr_get_date_options', [$this, 'ajax_get_date_options']);        add_action('admin_enqueue_scripts', [$this, 'enqueue_admin_js']);        add_action('wp_enqueue_scripts', [$this, 'enqueue_frontend_styles']);    }    public function register_pacchetto_singolo_module() {        vc_map([            'name'        => __('Pacchetto Born to Ride', 'born-to-ride'),            'base'        => 'btr_pacchetto_singolo',            'category'    => __('Born to Ride', 'born-to-ride'),            'description' => __('Mostra un pacchetto specifico con date disponibili.', 'born-to-ride'),            'params'      => [                [                    'type'        => 'dropdown',                    'heading'     => __('Pacchetto', 'born-to-ride'),                    'param_name'  => 'pacchetto_id',                    'value'       => ['Seleziona un pacchetto...' => ''] + $this->get_pacchetti_list(),                    'description' => __('Seleziona un pacchetto disponibile.', 'born-to-ride'),                    'admin_label' => true,                ],                [                    'type'        => 'dropdown',                    'heading'     => __('Tipo visualizzazione', 'born-to-ride'),                    'param_name'  => 'visualizzazione',                    'value'       => [                        __('Tutte le date', 'born-to-ride') => 'tutte',                        __('Solo alcune date specifiche', 'born-to-ride') => 'limitate',                    ],                    'admin_label' => true,                ],                [                    'type'        => 'param_group',                    'heading'     => __('Date specifiche (se limitate)', 'born-to-ride'),                    'param_name'  => 'date_limite',                    'params'      => [                        [                            'type'       => 'dropdown',                            'param_name' => 'data_scelta',                            'heading'    => __('Seleziona una data', 'born-to-ride'),                            'value'      => ['Seleziona una data...' => ''],                            'admin_label' => true,                        ]                    ],                    'dependency' => [                        'element' => 'visualizzazione',                        'value'   => ['limitate']                    ]                ],                [                    'type'        => 'dropdown',                    'heading'     => __('Template di visualizzazione', 'born-to-ride'),                    'param_name'  => 'template',                    'value'       => [                        __('Template Griglia', 'born-to-ride')  => 'griglia',                        __('Template Dettagliato', 'born-to-ride')  => 'dettagliato',                    ],                    'admin_label' => true,                ],                [                    'type'        => 'textfield',                    'heading'     => __('Titolo', 'born-to-ride'),                    'param_name'  => 'titolo',                    'description' => __('Titolo della sezione pacchetto (es: DATE).', 'born-to-ride'),                ],                [                    'type'        => 'textfield',                    'heading'     => __('Sottotitolo', 'born-to-ride'),                    'param_name'  => 'sottotitolo',                    'description' => __('Sottotitolo della sezione pacchetto (es: SCEGLI LA DATA...).', 'born-to-ride'),                ],                [                    'type'        => 'checkbox',                    'heading'     => __('Debug Output', 'born-to-ride'),                    'param_name'  => 'debug',                    'value'       => [__('Mostra dati di debug', 'born-to-ride') => 'yes'],                    'description' => __('Attiva per visualizzare i dati grezzi passati allo shortcode.', 'born-to-ride'),                ],            ]        ]);    }    public function render_pacchetto_singolo($atts) {        $atts = shortcode_atts([            'pacchetto_id'    => '',            'visualizzazione' => 'tutte',            'date_limite'     => '',            'template'        => 'base',            'debug'           => '',            'titolo'          => '',            'sottotitolo'     => '',        ], $atts, 'btr_pacchetto_singolo');        $pacchetto_id = absint($atts['pacchetto_id']);        if (!$pacchetto_id) {            // Fallback message if pacchetto_id is missing            return '<div class="btr-pacchetto-template btr-template-' . esc_attr($atts['template']) . '"><div class="btr-error">Nessun pacchetto selezionato. (ID mancante)</div></div>';        }        $date_meta = get_post_meta($pacchetto_id, 'btr_date_ranges', true);        if (!is_array($date_meta)) {            // Fallback message if date_meta is missing or not an array            return '<div class="btr-pacchetto-template btr-template-' . esc_attr($atts['template']) . '"><div class="btr-error">Nessuna data trovata nel meta campo &quot;btr_date_ranges&quot;.</div></div>';        }        $date_da_mostrare = [];        if ($atts['visualizzazione'] === 'tutte') {            $date_da_mostrare = $date_meta;        } elseif ($atts['visualizzazione'] === 'limitate') {            $limiti = function_exists('vc_param_group_parse_atts')                ? vc_param_group_parse_atts($atts['date_limite'])                : [];            $filtrate = [];            foreach ($date_meta as $range) {                foreach ($limiti as $limite) {                    if (!empty($limite['data_scelta']) && $range['start'] === $limite['data_scelta']) {                        $filtrate[] = $range;                    }                }            }            $date_da_mostrare = $filtrate;        }        $pagina_pubblica_id = get_post_meta($pacchetto_id, 'btr_pagina_pubblica_id', true);        $pagina_link = get_permalink($pagina_pubblica_id);        ob_start();        if ($atts['template'] === 'dettagliato') {            $btr_numero_giorni_fisse = get_post_meta($pacchetto_id, 'btr_numero_giorni_fisse', true);            $btr_numero_notti = get_post_meta($pacchetto_id, 'btr_numero_notti', true);            $durata = trim($btr_numero_giorni_fisse . ' giorni ' . $btr_numero_notti . ' notti');            echo '<div class="wpb_wrapper">';            if (!empty($atts['titolo'])) {                echo '<h2 style="color: #0097c5;text-align: left" class="vc_custom_heading vc_do_custom_heading">' . esc_html($atts['titolo']) . '</h2>';            }            if (!empty($atts['sottotitolo'])) {                echo '<h3 style="color: #000000;text-align: left" class="vc_custom_heading vc_do_custom_heading">' . esc_html($atts['sottotitolo']) . '</h3>';            }            echo '<div class="divider-wrap" data-alignment="default"><div style="height: 30px;" class="divider"></div></div>';            echo '<div class="wpb_row vc_row-fluid vc_row inner_row"><div class="row_col_wrap_12_inner col span_12 left">';            // Custom columns with new classes            echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-data"><div class="vc_column-inner"><div class="wpb_wrapper">';            echo '<div class="wpb_text_column wpb_content_element"><div class="wpb_wrapper"><p>Data</p></div></div>';            echo '</div></div></div>';            echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-durata"><div class="vc_column-inner"><div class="wpb_wrapper">';            echo '<div class="wpb_text_column wpb_content_element"><div class="wpb_wrapper"><p>Durata</p></div></div>';            echo '</div></div></div>';            echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-stato"><div class="vc_column-inner"><div class="wpb_wrapper">';            echo '<div class="wpb_text_column wpb_content_element"><div class="wpb_wrapper"><p>Stato</p></div></div>';            echo '</div></div></div>';            echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-prezzo"><div class="vc_column-inner"><div class="wpb_wrapper">';            echo '<div class="wpb_text_column wpb_content_element"><div class="wpb_wrapper"><p>Prezzo</p></div></div>';            echo '</div></div></div>';            echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-preventivo"><div class="vc_column-inner"><div class="wpb_wrapper">';            echo '<div class="wpb_text_column wpb_content_element"><div class="wpb_wrapper"><p></p></div></div>';            echo '</div></div></div>';            echo '</div></div>';            echo '<div class="divider-wrap" data-alignment="default"><div style="height: 30px;" class="divider"></div></div>';            $product_id = get_post_meta($pacchetto_id, '_btr_product_id', true);            $product = wc_get_product($product_id);            foreach ($date_da_mostrare as $range) {                $is_past = false;                if (!empty($range['end'])) {                    try {                        $now = new DateTime('now', wp_timezone());                        $end_date = new DateTime($range['end'], wp_timezone());                        $is_past = $now > $end_date;                    } catch (Exception $e) {                        $is_past = false;                    }                }                if (!empty($range['closed']) && $range['closed'] === '1') {                    $stato = 'SOLD OUT';                    $stato_label = 'SOLD OUT';                } elseif ($is_past) {                    $stato = 'CHIUSA';                    $stato_label = 'Prenotazioni chiuse';                } else {                    $stato = 'DISPONIBILE';                    $stato_label = 'DISPONIBILE';                }                $class = strtolower(str_replace(' ', '', $stato));                $disabled_attr = ($stato === 'CHIUSA') ? 'style="opacity: 0.5; pointer-events: none;"' : '';                echo '<div class="wpb_row vc_row-fluid vc_row inner_row vc_row-o-equal-height vc_row-flex vc_row-o-content-middle row-riga" ' . $disabled_attr . '>';                echo '<div class="row_col_wrap_12_inner col span_12 left">';                // Data column                echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-data"><div class="vc_column-inner"><div class="wpb_wrapper">';                $range_name = $range['name'] ?? ($range['start'] . ' → ' . $range['end']);                echo '<h4>' . esc_html($range_name) . '</h4>';                echo '</div></div></div>';                // Durata column                echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-durata"><div class="vc_column-inner"><div class="wpb_wrapper">';                echo '<p>' . esc_html($durata) . '</p>';                echo '</div></div></div>';                // Stato column                echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-stato"><div class="vc_column-inner"><div class="wpb_wrapper">';                echo '<div class="wpb_text_column wpb_content_element btr-status-' . esc_attr($class) . '"><div class="wpb_wrapper"><p>' . $stato_label . '</p></div></div>';                echo '</div></div></div>';                // Prezzo column                echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-prezzo"><div class="vc_column-inner"><div class="wpb_wrapper">';                $variante_id_link = '';                $variation_price = '—';                if ($product && $product->is_type('variable')) {                    $target_variation = null;                    $fallback_variation = null;                    foreach ($product->get_children() as $variation_id) {                        $variation = wc_get_product($variation_id);                        if (!$variation) continue;                        $date_attr = $variation->get_attribute('pa_date_disponibili');                        $room_type = strtolower($variation->get_attribute('pa_tipologia_camere'));                        // Match robusto usando sanitize_title()                        if (sanitize_title($date_attr) === sanitize_title($range['name'])) {                            if (!$fallback_variation) {                                $fallback_variation = $variation;                            }                            if ($room_type === 'singola') {                                $target_variation = $variation;                                break;                            }                        }                        $variante_id_link = $variation->get_id();                    }                    $variation_to_use = $target_variation ?: $fallback_variation;                    if ($variation_to_use) {                        $variation_price = wc_price($variation_to_use->get_price());                    }                }                echo '<h4>' . $variation_price . '</h4>';                echo '</div></div></div>';                // Preventivo column                $disabled_sold_out = ($stato === 'SOLD OUT') ? 'style="opacity: 0.5; pointer-events: none;"' : '';                echo '<div class="vc_col-sm-1/5 wpb_column column_container col child_column column-preventivo" '.$disabled_sold_out.'><div class="vc_column-inner"><div class="wpb_wrapper">';                echo '<div class="tilt-button-wrap"><div class="tilt-button-inner"><a class="nectar-button medium regular-tilt accent-color tilt regular-button" href="'                    .$pagina_link.'?dtpc='.sanitize_title($date_attr).'&idpc='.$variante_id_link.'"><span>CALCOLA PREVENTIVO</span></a></div></div>';                echo '</div></div></div>';                echo '</div></div>';            }            echo '</div>';            return ob_get_clean();        }        echo '<div class="btr-pacchetto-template btr-template-' . esc_attr($atts['template']) . '">';        if (!empty($atts['titolo'])) {            echo '<h2 class="btr-template-title">' . esc_html($atts['titolo']) . '</h2>';        }        if (!empty($atts['sottotitolo'])) {            echo '<h3 class="btr-template-subtitle">' . esc_html($atts['sottotitolo']) . '</h3>';        }        echo '<div class="btr-date-list-wrapper">';        if (empty($date_da_mostrare)) {            echo '<p class="btr-no-date">Nessuna data da mostrare.</p>';        } else {            foreach ($date_da_mostrare as $range) {                $range_name = $range['name'] ?? ($range['start'] . ' → ' . $range['end']);                $stato_label = 'Disponibile';                $stato = 'DISPONIBILE';                $disabled_class = '';                $prezzo = '—';                $is_chiusa = false;                $is_past = false;                if (!empty($range['end'])) {                    try {                        $now = new DateTime('now', wp_timezone());                        $end_date = new DateTime($range['end'], wp_timezone());                        $is_past = $now > $end_date;                    } catch (Exception $e) {}                }                if (!empty($range['closed']) && $range['closed'] === '1') {                    $stato_label = 'Prenotazioni chiuse';                    $disabled_class = ' disabled';                    $stato = 'SOLD OUT';                    $is_chiusa = true;                } elseif ($is_past) {                    $stato_label = 'Prenotazioni chiuse';                    $disabled_class = ' disabled';                    $stato = 'CHIUSA';                    $is_chiusa = true;                }                $class = strtolower(str_replace(' ', '', $stato));                // Ricava il prezzo della singola (fallback alla prima variazione) solo se non chiusa                $product_id = get_post_meta($pacchetto_id, '_btr_product_id', true);                $product = wc_get_product($product_id);                $target = null;                if ($product && $product->is_type('variable')) {                    foreach ($product->get_children() as $vid) {                        $v = wc_get_product($vid);                        if (!$v) continue;                        $date_attr = sanitize_title($v->get_attribute('pa_date_disponibili'));                        if ($date_attr === sanitize_title($range['name'])) {                            $room_type = strtolower($v->get_attribute('pa_tipologia_camere'));                            if ($room_type === 'singola') {                                $target = $v;                                break;                            }                            if (!$target) $target = $v;                        }                    }                        $prezzo = wc_price($target->get_price());                }                $btr_numero_giorni_fisse = get_post_meta($pacchetto_id, 'btr_numero_giorni_fisse', true);                $btr_numero_notti = get_post_meta($pacchetto_id, 'btr_numero_notti', true);                $durata = trim($btr_numero_giorni_fisse . ' giorni ' . $btr_numero_notti . ' notti');                if ($atts['template'] === 'griglia') {                    echo '<div class="btr-date-grid-item' . $disabled_class . '">';                    echo '<div class="btr-date-range"><strong>' . esc_html($range_name) . '</strong></div>';                    echo '<div class="btr-date-status btr-status-' . esc_attr($class) . '">' . esc_html($stato_label) . '</div>';                    echo '<div class="btr-date-durata">' . esc_html($durata) . '</div>';                    echo '<div class="btr-date-price">' . $prezzo . '</div>';                    if (empty($disabled_class)) {                        $pagina_pubblica_id = get_post_meta($pacchetto_id, 'btr_pagina_pubblica_id', true);                        $pagina_link = get_permalink($pagina_pubblica_id);                        echo '<div class="btr-date-action"><a class="btr-date-btn" href="' . esc_url($pagina_link . '?dtpc=' . sanitize_title($range['name'])) . '">Calcola Preventivo</a></div>';                    } else {                        echo '<div class="btr-date-action"><span class="btr-date-btn disabled">Non Disponibile</span></div>';                    }                    echo '</div>';                } elseif ($atts['template'] === 'lista') {                    echo '<li class="btr-date-item' . $disabled_class . '"><strong>' . esc_html($range_name) . '</strong>: ' . esc_html($stato_label) . ' – ' . $prezzo . '</li>';                } else {                    echo '<p class="btr-date-item' . $disabled_class . '"><strong>' . esc_html($range_name) . '</strong>: ' . esc_html($stato_label) . ' – ' . $prezzo . '</p>';                }            }        }        echo '</div></div>';        if ($atts['debug'] === 'yes') {            echo '<pre class="btr-debug">';            echo "Shortcode Attributi:\n";            print_r($atts);            echo "\nDate Meta:\n";            print_r($date_meta);            echo '</pre>';        }        return ob_get_clean();    }    public function ajax_get_date_options() {        if (!isset($_POST['pacchetto_id']) || !is_numeric($_POST['pacchetto_id'])) {            wp_send_json_error('Invalid pacchetto_id');        }        $pacchetto_id = intval($_POST['pacchetto_id']);        $ranges = get_post_meta($pacchetto_id, 'btr_date_ranges', true);        if (!is_array($ranges)) $ranges = [];        $options = [];        foreach ($ranges as $range) {            if (!empty($range['start']) && (!isset($range['closed']) || $range['closed'] !== '1')) {                $text = $range['start'];                if (!empty($range['end'])) {                    $text .= ' → ' . $range['end'];                }                if (!empty($range['label'])) {                    $text .= ' (' . $range['label'] . ')';                }                $options[] = ['label' => $text, 'value' => $range['start']];            }        }        wp_send_json_success($options);    }    public function enqueue_admin_js() {        //wp_enqueue_script('btr-wpbakery-admin', plugin_dir_url(__FILE__) . 'js/btr-wpbakery-admin.js', ['jquery'], null, true);        wp_localize_script('btr-wpbakery-admin', 'btr_ajax', [            'ajax_url' => admin_url('admin-ajax.php'),        ]);    }    private function get_pacchetti_list(): array {        $posts = get_posts([            'post_type'      => 'btr_pacchetti',            'posts_per_page' => -1,            'post_status'    => 'publish',            'orderby'        => 'title',            'order'          => 'ASC',        ]);        $list = [];        foreach ($posts as $post) {            $list[$post->post_title] = (string) $post->ID;        }        return $list;    }    public function enqueue_frontend_styles() {
        if (!is_admin()) {
            // Enqueue frontend styles
            wp_enqueue_style(
                'btr-pacchetto-frontend',
                plugin_dir_url(__FILE__) . '../assets/css/btr-pacchetto-frontend.css',
                [],
                '1.0'
            );
            
            // Enqueue date picker CSS
            wp_enqueue_style(
                'btr-datepicker',
                plugin_dir_url(__FILE__) . '../assets/css/btr-datepicker.css',
                [],
                '1.0'
            );
            
            // Enqueue date picker JS
            wp_enqueue_script(
                'btr-datepicker',
                plugin_dir_url(__FILE__) . '../assets/js/btr-datepicker.js',
                ['jquery'],
                '1.0',
                true
            );
            
            // Enqueue date picker initialization JS
            wp_enqueue_script(
                'btr-datepicker-init',
                plugin_dir_url(__FILE__) . '../assets/js/btr-datepicker-init.js',
                ['jquery', 'btr-datepicker'],
                '1.0',
                true
            );
            
            // Enqueue select CSS
            wp_enqueue_style(
                'btr-select',
                plugin_dir_url(__FILE__) . '../assets/css/btr-select.css',
                [],
                '1.0'
            );
            
            // Enqueue select JS
            wp_enqueue_script(
                'btr-select',
                plugin_dir_url(__FILE__) . '../assets/js/btr-select.js',
                ['jquery'],
                '1.0',
                true
            );
        }
    }}new BTR_WPBakery_Modules();