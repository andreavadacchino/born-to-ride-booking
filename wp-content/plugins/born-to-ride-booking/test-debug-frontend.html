<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Test Debug Frontend - Costi Extra</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .test-section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .participant { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .debug-output { background: #272822; color: #f8f8f2; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button { background: #0073aa; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #005177; }
        .checkbox-group { margin: 10px 0; }
        .checkbox-group label { display: block; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üß™ Test Debug Frontend - Costi Extra</h1>
    
    <div class="test-section">
        <h2>1. Simulazione Form Partecipanti</h2>
        
        <div class="participant">
            <h3>Partecipante 1</h3>
            <input type="text" name="anagrafici[0][nome]" value="Mario" placeholder="Nome">
            <input type="text" name="anagrafici[0][cognome]" value="Rossi" placeholder="Cognome">
            
            <div class="checkbox-group">
                <h4>Costi Extra:</h4>
                <label>
                    <input type="checkbox" name="anagrafici[0][costi_extra][animale-domestico]" value="1">
                    Animale domestico (‚Ç¨15.00)
                </label>
                <label>
                    <input type="checkbox" name="anagrafici[0][costi_extra][culla-per-neonati]" value="1">
                    Culla per neonati (‚Ç¨15.00)
                </label>
                <label>
                    <input type="checkbox" name="anagrafici[0][costi_extra][seggiolino-auto]" value="1">
                    Seggiolino auto (‚Ç¨15.00)
                </label>
            </div>
        </div>
        
        <div class="participant">
            <h3>Partecipante 2</h3>
            <input type="text" name="anagrafici[1][nome]" value="Laura" placeholder="Nome">
            <input type="text" name="anagrafici[1][cognome]" value="Bianchi" placeholder="Cognome">
            
            <div class="checkbox-group">
                <h4>Costi Extra:</h4>
                <label>
                    <input type="checkbox" name="anagrafici[1][costi_extra][animale-domestico]" value="1">
                    Animale domestico (‚Ç¨15.00)
                </label>
                <label>
                    <input type="checkbox" name="anagrafici[1][costi_extra][culla-per-neonati]" value="1">
                    Culla per neonati (‚Ç¨15.00)
                </label>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Raccolta Dati</h2>
        <button onclick="testRaccoltaDati()">üîç Test Raccolta Costi Extra</button>
        <button onclick="testSelettoreOriginale()">üîç Test Selettore Originale</button>
        <button onclick="testSelettoreMigliorato()">üîç Test Selettore Migliorato</button>
        
        <div id="debug-output" class="debug-output" style="display:none;"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Simulazione Invio Form</h2>
        <button onclick="simulaInvioForm()">üì§ Simula Invio Form</button>
        
        <div id="form-data-output" class="debug-output" style="display:none;"></div>
    </div>

    <script>
    function log(message, data = null) {
        const output = document.getElementById('debug-output');
        output.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        let html = output.innerHTML;
        html += `[${timestamp}] ${message}`;
        if (data) {
            html += '\n' + JSON.stringify(data, null, 2);
        }
        html += '\n\n';
        output.innerHTML = html;
    }
    
    function clearLog() {
        document.getElementById('debug-output').innerHTML = '';
        document.getElementById('form-data-output').innerHTML = '';
    }
    
    function testSelettoreOriginale() {
        clearLog();
        log('=== TEST SELETTORE ORIGINALE ===');
        log('Selettore: $("input[type=\\"checkbox\\"]:checked")');
        
        const checkboxes = $('input[type="checkbox"]:checked');
        log(`Trovati ${checkboxes.length} checkbox selezionati`);
        
        checkboxes.each(function() {
            const name = $(this).attr('name');
            const value = $(this).val();
            log(`Checkbox: ${name} = ${value}`);
        });
    }
    
    function testSelettoreMigliorato() {
        clearLog();
        log('=== TEST SELETTORE MIGLIORATO ===');
        log('Selettore: $("input[type=\\"checkbox\\"][name*=\\"[costi_extra]\\"]:checked")');
        
        const checkboxes = $('input[type="checkbox"][name*="[costi_extra]"]:checked');
        log(`Trovati ${checkboxes.length} checkbox costi extra selezionati`);
        
        checkboxes.each(function() {
            const name = $(this).attr('name');
            const value = $(this).val();
            log(`Checkbox costi extra: ${name} = ${value}`);
        });
    }
    
    function testRaccoltaDati() {
        clearLog();
        log('=== TEST RACCOLTA DATI COMPLETA ===');
        
        // Simula array anagrafici
        const anagrafici = [];
        
        // Inizializza partecipanti
        $('.participant').each(function(index) {
            const participant = {
                nome: $(this).find(`input[name="anagrafici[${index}][nome]"]`).val(),
                cognome: $(this).find(`input[name="anagrafici[${index}][cognome]"]`).val(),
                costi_extra: {}
            };
            anagrafici.push(participant);
        });
        
        log('Partecipanti inizializzati:', anagrafici);
        
        // Raccogli costi extra con selettore migliorato
        $('input[type="checkbox"][name*="[costi_extra]"]:checked').each(function() {
            const name = $(this).attr('name');
            const value = $(this).val();
            
            log(`Processing checkbox: ${name}`);
            
            // Pattern matching per estrarre indice e slug
            const match = name.match(/anagrafici\[(\d+)\]\[costi_extra\]\[([^\]]+)\]/);
            if (match) {
                const participantIndex = parseInt(match[1], 10);
                const costoSlug = match[2];
                
                log(`Match trovato: index=${participantIndex}, slug=${costoSlug}`);
                
                if (participantIndex >= 0 && participantIndex < anagrafici.length) {
                    if (!anagrafici[participantIndex].costi_extra) {
                        anagrafici[participantIndex].costi_extra = {};
                    }
                    anagrafici[participantIndex].costi_extra[costoSlug] = true;
                    log(`‚úÖ Assegnato: anagrafici[${participantIndex}].costi_extra[${costoSlug}] = true`);
                }
            }
        });
        
        log('=== RISULTATO FINALE ===');
        log('Anagrafici con costi extra:', anagrafici);
    }
    
    function simulaInvioForm() {
        clearLog();
        const outputDiv = document.getElementById('form-data-output');
        outputDiv.style.display = 'block';
        outputDiv.innerHTML = '<h3>üì§ Simulazione Invio Form</h3>';
        
        // Raccogli dati come farebbe il frontend reale
        const formData = new FormData();
        const anagrafici = [];
        
        $('.participant').each(function(index) {
            const participant = {
                nome: $(this).find(`input[name="anagrafici[${index}][nome]"]`).val(),
                cognome: $(this).find(`input[name="anagrafici[${index}][cognome]"]`).val(),
                costi_extra: {}
            };
            anagrafici.push(participant);
        });
        
        // Raccogli costi extra
        $('input[type="checkbox"][name*="[costi_extra]"]:checked').each(function() {
            const name = $(this).attr('name');
            const match = name.match(/anagrafici\[(\d+)\]\[costi_extra\]\[([^\]]+)\]/);
            if (match) {
                const idx = parseInt(match[1], 10);
                const slug = match[2];
                if (anagrafici[idx]) {
                    anagrafici[idx].costi_extra[slug] = true;
                }
            }
        });
        
        // Simula invio dati
        anagrafici.forEach(function(partecipante, i) {
            const costiExtraJson = JSON.stringify(partecipante.costi_extra || {});
            
            outputDiv.innerHTML += `
                <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <strong>Partecipante ${i + 1}:</strong> ${partecipante.nome} ${partecipante.cognome}<br>
                    <strong>costi_extra JSON:</strong> <code>${costiExtraJson}</code><br>
                    <strong>Chiavi inviate:</strong><br>
                    - anagrafici[${i}][nome] = "${partecipante.nome}"<br>
                    - anagrafici[${i}][cognome] = "${partecipante.cognome}"<br>
                    - anagrafici[${i}][costi_extra] = "${costiExtraJson}"
                </div>
            `;
            
            // Mostra cosa verrebbe inviato
            formData.append(`anagrafici[${i}][nome]`, partecipante.nome);
            formData.append(`anagrafici[${i}][cognome]`, partecipante.cognome);
            formData.append(`anagrafici[${i}][costi_extra]`, costiExtraJson);
        });
        
        outputDiv.innerHTML += '<p class="success">‚úÖ Dati pronti per l\'invio al backend PHP</p>';
    }
    
    // Auto-seleziona alcuni checkbox per il test
    $(document).ready(function() {
        $('input[name="anagrafici[0][costi_extra][animale-domestico]"]').prop('checked', true);
        $('input[name="anagrafici[0][costi_extra][culla-per-neonati]"]').prop('checked', true);
        $('input[name="anagrafici[1][costi_extra][animale-domestico]"]').prop('checked', true);
    });
    </script>
</body>
</html> 