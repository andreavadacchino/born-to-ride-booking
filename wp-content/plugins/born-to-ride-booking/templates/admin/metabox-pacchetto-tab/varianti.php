<div class="btr-section collapsible active">    <?php    $product_id = get_post_meta($post->ID, '_btr_product_id', true);    ?>    <h2>Riepilogo Varianti WooCommerce</h2>    <div class="section-content">        <div class="btr-variant-intro" style="margin-bottom: 20px;">            <p style="margin-bottom: 8px;">                Questo riepilogo mostra tutte le varianti del prodotto WooCommerce associate a questo pacchetto, ordinate per data. Ogni variante rappresenta una combinazione univoca di tipologia camera e data disponibile, con dettagli su prezzo, supplementi, sconti e disponibilità aggiornata. <br><br>                Nel campo <strong>Disponibilità</strong> il formato <code>attuale/originale</code> indica i posti attualmente disponibili rispetto a quelli originariamente previsti (esempio: <code>2/5</code> significa 2 posti disponibili su 5 iniziali).            </p>            <a href="<?php echo esc_url(get_edit_post_link($product_id)); ?>" target="_blank" class="btr-modern-button">Vai al prodotto WooCommerce</a>        </div>        <?php        if ($product_id && function_exists('wc_get_product')) {            $product = wc_get_product($product_id);            $variations = $product->get_available_variations();            if (!empty($variations)) {                // Ordina per data variante                usort($variations, function ($a, $b) {                    $a_date = $a['attributes']['attribute_pa_date_disponibili'] ?? '';                    $b_date = $b['attributes']['attribute_pa_date_disponibili'] ?? '';                    return strcmp($a_date, $b_date);                });                echo '<div class="btr-variant-summary">';                echo '<div class="btr-product-header">';                echo '<strong>Prodotto WooCommerce:</strong> ' . esc_html($product->get_name()) . ' <span class="btr-product-id">(#' . esc_html($product_id) . ')</span>';                echo '</div>';                echo '<table class="btr-variant-table">';                echo '<thead>                                    <tr>                                        <th>Data</th>                                        <th>Camera</th>                                        <th style="text-align: center">Prezzo</th>                                        <th style="text-align: center">Prezzo / persona</th>                                        <th style="text-align: center">Disponibilità</th>                                        <th style="text-align: center">Supplemento</th>                                        <th style="text-align: center">Sconto</th>                                    </tr>                                </thead><tbody>';                foreach ($variations as $variation) {                    $attrs = $variation['attributes'];                    $room = $attrs['attribute_pa_tipologia_camere'] ?? '—';                    $date = $attrs['attribute_pa_date_disponibili'] ?? '—';                    $posti_per_camera = [                        'Singola' => 1,                        'Doppia' => 2,                        'Tripla' => 3,                        'Quadrupla' => 4,                        'Quintupla' => 5,                        'Condivisa' => 1,                    ];                    $posti = $posti_per_camera[$room] ?? 1;                    $prezzo_totale = wc_price($variation['display_price'] * $posti);                    $prezzo_per_persona = wc_price($variation['display_price']);                    $stock = !empty( $variation['max_qty'] ) ? $variation['max_qty'] : 0;                    $variation_id = $variation['variation_id'];                    $stock_orig = get_post_meta($variation_id, '_btr_giacenza_origine', true) ?: '—';                    $supplemento = $variation['_btr_supplemento'] !== '' ? wc_price((float) $variation['_btr_supplemento']) : '—';                    $sconto = $variation['_btr_sconto_percentuale'] !== '' ? esc_html($variation['_btr_sconto_percentuale']) . '%' : '—';                    $stock_color = ($stock_orig !== '—' && $stock != $stock_orig) ? 'style="color:#d63638;font-weight:bold; text-align: center"' : 'style="text-align: center"';                    echo '<tr>';                    echo "<td><strong>{$date}</strong></td>";                    echo "<td>{$room}</td>";                    echo "<td style='text-align: center'>{$prezzo_totale}</td>";                    echo "<td style='text-align: center'>{$prezzo_per_persona}</td>";                    echo "<td {$stock_color}>" . esc_html("{$stock}/{$stock_orig}") . "</td>";                    echo "<td style='text-align: center'>{$supplemento}</td>";                    echo "<td style='text-align: center'>{$sconto}</td>";                    echo '</tr>';                }                echo '</tbody></table></div>';            } else {                echo '<p>Nessuna variante disponibile per il prodotto associato.</p>';            }        } else {            echo '<p>Nessun prodotto WooCommerce collegato al pacchetto.</p>';        }        ?>    </div></div>