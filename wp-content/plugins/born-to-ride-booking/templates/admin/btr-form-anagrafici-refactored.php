<?php/** * Template: Form Anagrafici * * This template handles the display and processing of the participant data form * for the Born to Ride booking system. * * @package Born_To_Ride_Booking * @version 1.0.0 * @since 1.0.0 * * Uses the variables: * - $order_id: The ID of the order * - $preventivo_id: The ID of the quote * - $anagrafici: Array of participant data * - $totale_persone: Total number of participants * - $remaining_time: Remaining time to complete the form * - $camere_acquistate: Array of purchased rooms */// Exit if accessed directlyif ( ! defined( 'ABSPATH' ) ) {    exit;}/** * Class BTR_Form_Anagrafici * * Handles the display and processing of the participant data form. */class BTR_Form_Anagrafici {    /**     * Order ID     *     * @var int     */    private $order_id;    /**     * Quote ID     *     * @var int     */    private $preventivo_id;    /**     * Participant data     *     * @var array     */    private $anagrafici;    /**     * Total number of participants     *     * @var int     */    private $totale_persone;    /**     * Remaining time to complete the form     *     * @var int     */    private $remaining_time;    /**     * Purchased rooms     *     * @var array     */    private $camere_acquistate;    /**     * Package ID     *     * @var int     */    private $package_id;    /**     * Package data     *     * @var array     */    private $package_data;    /**     * Constructor     *     * @param int   $order_id         Order ID.     * @param int   $preventivo_id    Quote ID.     * @param array $anagrafici       Participant data.     * @param int   $totale_persone   Total number of participants.     * @param int   $remaining_time   Remaining time to complete the form.     * @param array $camere_acquistate Purchased rooms.     */    public function __construct( $order_id, $preventivo_id, $anagrafici, $totale_persone, $remaining_time, $camere_acquistate ) {        $this->order_id         = $order_id;        $this->preventivo_id    = $preventivo_id;        $this->anagrafici       = $this->prepare_anagrafici( $anagrafici );        $this->totale_persone   = $totale_persone;        $this->remaining_time   = $remaining_time;        $this->camere_acquistate = $camere_acquistate;        // Get package ID and load package data        $this->package_id = $this->get_package_id();        $this->package_data = $this->load_package_data();    }    /**     * Prepare anagrafici data     *     * Ensures the anagrafici data is in the correct format.     *     * @param mixed $anagrafici Participant data.     * @return array Prepared participant data.     */    private function prepare_anagrafici( $anagrafici ) {        if ( is_string( $anagrafici ) ) {            $maybe_array = json_decode( $anagrafici, true );            if ( json_last_error() === JSON_ERROR_NONE ) {                return $maybe_array;            } else {                return maybe_unserialize( $anagrafici );            }        }        return is_array( $anagrafici ) ? $anagrafici : array();    }    /**     * Get package ID     *     * @return int Package ID.     */    private function get_package_id() {        return (int) get_post_meta( $this->preventivo_id, '_pacchetto_id', true );    }    /**     * Load package data     *     * @return array Package data.     */    private function load_package_data() {        $data = array();        // Basic package data        $data['destinazione'] = get_post_meta( $this->package_id, 'btr_destinazione', true );        $data['localita_destinazione'] = get_post_meta( $this->package_id, 'btr_localita_destinazione', true );        // Quote data        $data['data_pacchetto'] = get_post_meta( $this->preventivo_id, '_data_pacchetto', true );        $data['durata'] = get_post_meta( $this->preventivo_id, '_durata', true );        $data['prezzo_totale'] = get_post_meta( $this->preventivo_id, '_prezzo_totale', true );        $data['nome_pacchetto'] = get_post_meta( $this->preventivo_id, '_nome_pacchetto', true );        // Extra night        $data['extra_night'] = get_post_meta( $this->preventivo_id, '_extra_night', true );        $data['durata_label'] = $data['durata'];        if ( ! empty( $data['extra_night'] ) && intval( $data['extra_night'] ) === 1 ) {            $data['durata_label'] .= ' + 1 ' . esc_html__( 'notte extra', 'born-to-ride-booking' );        }        // Participant data        $data['num_adults'] = get_post_meta( $this->preventivo_id, '_num_adults', true );        $data['num_children'] = get_post_meta( $this->preventivo_id, '_num_children', true );        // Insurance data        $data['assicurazione_importi'] = get_post_meta( $this->package_id, 'btr_assicurazione_importi', true );        $data['assicurazioni_prodotti'] = get_post_meta( $this->package_id, 'btr_assicurazioni_prodotti', true );        return $data;    }    /**     * Render the form     */    public function render() {        // Apply filters to allow customization        $this->anagrafici = apply_filters( 'btr_form_anagrafici_data', $this->anagrafici, $this->preventivo_id );        $this->package_data = apply_filters( 'btr_form_package_data', $this->package_data, $this->package_id );        // Start output        $this->render_header();        $this->render_form_start();        $this->render_package_details();        $this->render_participants_form();        $this->render_checkout_summary();        $this->render_form_end();    }    /**     * Render the header section     */    private function render_header() {        if ( $this->remaining_time > 0 ) {            $this->render_countdown_header();        } else {            $this->render_standard_header();        }    }    /**     * Render the countdown header     */    private function render_countdown_header() {        ?>        <div id="btr-header-container" class="btr-header-container">            <div class="btr-form-title-container">                <h2 class="btr-form-title"><?php esc_html_e( 'Inserisci i dati anagrafici e assegna le camere', 'born-to-ride-booking' ); ?></h2>                <p class="btr-form-subtitle"><?php printf( esc_html__( 'Totale persone: %d', 'born-to-ride-booking' ), $this->totale_persone ); ?></p>                <p class="form-subtitle mancanti-container">                    <span>                        <?php esc_html_e( 'Persone con dati mancanti:', 'born-to-ride-booking' ); ?>                        <span class="mancanti">0</span>/<span class="totale-persone"><?php echo esc_html( $this->totale_persone ); ?></span>                    </span>                </p>            </div>            <div id="btr-countdown" class="btr-countdown" data-remaining-time="<?php echo esc_attr( $this->remaining_time ); ?>">                <div class="btr-countdown-title">                    <?php esc_html_e( 'Tempo rimanente per completare i dati:', 'born-to-ride-booking' ); ?>                </div>                <div class="btr-countdown-timer">                    <div class="btr-countdown-box">                        <span class="btr-time" id="btr-hours">--</span>                        <span class="btr-label"><?php esc_html_e( 'Ore', 'born-to-ride-booking' ); ?></span>                    </div>                    <div class="btr-countdown-divider">:</div>                    <div class="btr-countdown-box">                        <span class="btr-time" id="btr-minutes">--</span>                        <span class="btr-label"><?php esc_html_e( 'Min.', 'born-to-ride-booking' ); ?></span>                    </div>                    <div class="btr-countdown-divider">:</div>                    <div class="btr-countdown-box">                        <span class="btr-time" id="btr-seconds">--</span>                        <span class="btr-label"><?php esc_html_e( 'Sec.', 'born-to-ride-booking' ); ?></span>                    </div>                </div>            </div>        </div>        <?php    }    /**     * Render the standard header     */    private function render_standard_header() {        ?>        <div class="wpb_wrapper ps-1">            <h2 id="title-step" style="color: #0097c5;text-align: left; font-size: 30px; margin-bottom:0" class="vc_custom_heading vc_do_custom_heading"><?php esc_html_e( 'Concludi l\'ordine', 'born-to-ride-booking' ); ?></h2>            <p id="desc-step">                <?php                printf(                    esc_html( _n(                        'Inserisci tutti i dati per partecipare al camp!',                        'Inserisci tutti i dati dei %d utenti per partecipare al camp!',                        $this->totale_persone,                        'born-to-ride-booking'                    ) ),                    $this->totale_persone                );                ?>            </p>        </div>        <?php    }    /**     * Render the form start     */    private function render_form_start() {        if ( empty( $this->remaining_time ) ) {            ?>            <form class="btr-form" action="<?php echo esc_url( admin_url( 'admin-post.php' ) ); ?>" method="POST">            <?php        } else {            ?>            <form id="btr-anagrafici-form" class="btr-form">            <?php        }        // Add nonce field for security        wp_nonce_field( 'btr_update_anagrafici_nonce', 'btr_update_anagrafici_nonce_field' );        ?>        <input type="hidden" name="action" value="btr_save_anagrafici">        <input type="hidden" name="order_id" value="<?php echo esc_attr( $this->order_id ); ?>">        <input type="hidden" name="preventivo_id" value="<?php echo esc_attr( $this->preventivo_id ); ?>">        <?php    }    /**     * Render package details     */    private function render_package_details() {        // Prepare room summary        $riepilogo_camere = array();        foreach ( $this->camere_acquistate as $camera ) {            $tipo = strtolower( $camera['tipo'] ?? '' );            $quantita = intval( $camera['quantita'] ?? 1 );            if ( ! empty( $tipo ) ) {                if ( ! isset( $riepilogo_camere[ $tipo ] ) ) {                    $riepilogo_camere[ $tipo ] = 0;                }                $riepilogo_camere[ $tipo ] += $quantita;            }        }        $riepilogo_stringa = array();        foreach ( $riepilogo_camere as $tipo => $quantita ) {            $riepilogo_stringa[] = $quantita . ' ' . $tipo . ( $quantita > 1 ? 'e' : '' );        }        $total_camere = array_sum( $riepilogo_camere );        $etichetta_tipologia = $total_camere === 1 ? 'camera' : 'camere';        ?>        <div class="btr-card">            <div class="btr-card-header">                <h2>                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>                    <?php esc_html_e( 'Dettagli Pacchetto', 'born-to-ride-booking' ); ?>                </h2>            </div>            <div class="btr-card-body">                <div class="btr-summary-box">                    <div class="btr-summary-title"><?php esc_html_e( 'Riepilogo', 'born-to-ride-booking' ); ?></div>                    <div class="btr-summary-list">                        <div class="btr-summary-item" style="justify-content: flex-start;">                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>                            <span><?php echo esc_html( $this->package_data['num_adults'] + $this->package_data['num_children'] ); ?> <?php esc_html_e( 'partecipanti', 'born-to-ride-booking' ); ?></span>                        </div>                        <div class="btr-summary-item" style="justify-content: flex-start;">                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>                            <span><?php echo esc_html( implode( ' - ', $riepilogo_stringa ) ); ?></span>                        </div>                        <div class="btr-summary-item" style="justify-content: flex-start;">                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>                            <span><?php echo esc_html( $this->package_data['durata_label'] ); ?></span>                        </div>                    </div>                </div>                <div class="btr-grid">                    <div class="btr-info-group">                        <span class="btr-info-label"><?php esc_html_e( 'Pacchetto', 'born-to-ride-booking' ); ?></span>                        <div class="btr-info-value"><?php echo esc_html( $this->package_data['nome_pacchetto'] ); ?></div>                    </div>                    <div class="btr-info-group">                        <span class="btr-info-label"><?php esc_html_e( 'Data', 'born-to-ride-booking' ); ?></span>                        <div class="btr-info-value">                            <?php echo esc_html( $this->get_formatted_package_date() ); ?>                        </div>                    </div>                    <div class="btr-info-group">                        <span class="btr-info-label"><?php esc_html_e( 'Durata', 'born-to-ride-booking' ); ?></span>                        <div class="btr-info-value"><?php echo esc_html( $this->package_data['durata_label'] ); ?></div>                    </div>                    <div class="btr-info-group">                        <span class="btr-info-label"><?php esc_html_e( 'Partecipanti', 'born-to-ride-booking' ); ?></span>                        <div class="btr-info-value">                            <?php echo esc_html( $this->package_data['num_adults'] ); ?> <?php esc_html_e( 'adulti', 'born-to-ride-booking' ); ?>                            <?php if ( $this->package_data['num_children'] > 0 ) : ?>                                + <?php echo esc_html( $this->package_data['num_children'] ); ?> <?php esc_html_e( 'bambini', 'born-to-ride-booking' ); ?>                            <?php endif; ?>                        </div>                    </div>                </div>            </div>        </div>        <?php    }    /**     * Get formatted package date     *     * @return string Formatted date.     */    private function get_formatted_package_date() {        if ( ! empty( $this->package_data['data_pacchetto'] ) ) {            return $this->package_data['data_pacchetto'];        } else {            // Fallback: get the date from the package if available            $package_date = get_post_meta( $this->package_id, 'btr_data_inizio', true );            if ( ! empty( $package_date ) ) {                // Also update the preventivo meta for future use                update_post_meta( $this->preventivo_id, '_data_pacchetto', $package_date );                return $package_date;            } else {                // If no date is available, show current date as fallback                return date_i18n( get_option( 'date_format' ) );            }        }    }    /**     * Generate room buttons HTML     *     * @return string Room buttons HTML.     */    private function generate_room_buttons_html() {        ob_start();        ?>        <div class="btr-room-buttons">            <?php            // Default capacity for each room type            $btr_default_capacita = array(                'Singola'             => 1,                'Doppia'              => 2,                'Doppia/Matrimoniale' => 2,                'Tripla'              => 3,                'Quadrupla'           => 4,                'Quintupla'           => 5,                'Condivisa'           => 6,            );            // Prepare array of letters for room labels            $lettere = range( 'A', 'Z' );            ?>            <?php foreach ( $this->camere_acquistate as $camera_id => $camera ) : ?>                <?php for ( $i = 1; $i <= $camera['quantita']; $i++ ) : ?>                    <?php                    // Sequential letter (A, B, C…) for each room of the same type                    $lettera = chr( 65 + $i - 1 );                    $etichetta_camera = $camera['tipo'] . ' (' . $lettera . ')';                    // Determine the actual capacity: if not present or not valid use the default                    $capacita_camera = ( isset( $camera['capacita'] ) && intval( $camera['capacita'] ) > 0 )                        ? intval( $camera['capacita'] )                        : ( $btr_default_capacita[ $camera['tipo'] ] ?? 1 );                    ?>                    <a type="button" class="btr-room-button"                        data-room-id="<?php echo esc_attr( $camera_id . '-' . $i ); ?>"                        data-room-type="<?php echo esc_attr( $camera['tipo'] ); ?>"                        data-capacita="<?php echo esc_attr( $capacita_camera ); ?>">                        <div class="btr-room-icon">                            <?php if ( $camera['tipo'] === 'Doppia' ) : ?>                                <!-- Doppia Icon -->                                <svg id="Raggruppa_35" data-name="Raggruppa 35" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="45.18" height="41.607" viewBox="0 0 45.18 41.607">                                  <defs>                                    <clipPath id="clip-path-doppia">                                      <rect width="45.18" height="41.607" fill="#fff"/>                                    </clipPath>                                  </defs>                                  <g clip-path="url(#clip-path-doppia)">                                    <path d="M45.18,26.337V38.578A3.621,3.621,0,0,1,38.8,40.253a4.118,4.118,0,0,1-.747-1.63V36.905H7.239v1.717a4.116,4.116,0,0,1-.747,1.63A3.621,3.621,0,0,1,.108,38.578c.255-3.952-.341-8.34,0-12.242a10.632,10.632,0,0,1,2.727-5.859l0-14.886A6.279,6.279,0,0,1,8.336,0H36.689a6.266,6.266,0,0,1,5.589,5.593V20.3a10.6,10.6,0,0,1,2.9,6.035m-4.666-7.4V5.508c0-1.625-2.33-3.8-4-3.747L8.349,1.775C6.846,1.841,4.6,3.944,4.6,5.42V19.115a5.785,5.785,0,0,1,1.838-.891c.1-1.437-.192-3,.235-4.389a4.721,4.721,0,0,1,4.041-3.267c2.873-.2,5.987.151,8.885.014a4.99,4.99,0,0,1,3.015,1.833c.193.033.383-.395.516-.521a5.129,5.129,0,0,1,2.562-1.312c2.911.156,6.094-.241,8.973-.013A4.778,4.778,0,0,1,38.64,13.9c.4,1.363.107,2.917.212,4.324ZM21.764,17.53V14.844a3.094,3.094,0,0,0-2.284-2.471c-2.785.086-5.834-.249-8.591-.043a2.883,2.883,0,0,0-2.363,1.6,7.152,7.152,0,0,0-.318.915v2.862c.542-.052,1.177-.159,1.713-.18,3.911-.152,7.923.121,11.844,0m15.317.176V14.844c0-1.228-1.507-2.426-2.681-2.514-2.739-.2-5.753.142-8.52.027a3.165,3.165,0,0,0-2.356,2.4V17.53c3.947.124,8-.164,11.932,0,.508.021,1.111.13,1.625.18M43.419,29.86V26.469a9.429,9.429,0,0,0-1.161-3.33,8.17,8.17,0,0,0-6.89-3.852c-8.314-.438-17.007.339-25.36,0-3.671-.278-8.139,3.457-8.139,7.182V29.86h23.9a1.006,1.006,0,0,1,.906.858c.025.269-.281.9-.554.9H1.869v3.523h41.55V31.621H34.308a1.278,1.278,0,0,1-.5-.463.955.955,0,0,1,.769-1.3ZM5.478,36.905H1.869v1.453c0,.03.189.489.229.564a1.85,1.85,0,0,0,3.1.127,4.973,4.973,0,0,0,.278-.6Zm37.941,0H39.81v1.541a4.973,4.973,0,0,0,.278.6,1.85,1.85,0,0,0,3.1-.127c.039-.075.229-.534.229-.564Z" fill="#fff"/>                                    <path d="M250.993,255.053a.873.873,0,1,1-.873-.873.873.873,0,0,1,.873.873" transform="translate(-219.922 -224.274)" fill="#fff"/>                                  </g>                                </svg>                            <?php elseif ( $camera['tipo'] === 'Singola' ) : ?>                                <!-- Singola Icon -->                                <svg id="Raggruppa_37" data-name="Raggruppa 37" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="52.956" height="29.804" viewBox="0 0 52.956 29.804">                                  <defs>                                    <clipPath id="clip-path-singola">                                      <rect width="52.956" height="29.804" fill="#fff"/>                                    </clipPath>                                  </defs>                                  <g clip-path="url(#clip-path-singola)">                                    <path d="M0,1.971a2.522,2.522,0,0,1,4.576-.8,4.94,4.94,0,0,1,.388.851v7.9a5.818,5.818,0,0,1,1.109-.6,29.743,29.743,0,0,1,6.791-.217,4.039,4.039,0,0,1,3.375,2.671,4.763,4.763,0,0,1,2.632-1.037h26.9a4.468,4.468,0,0,1,2.219.83c-.512-3.43,3.78-4.685,4.966-1.342V29.224c-.206.248-.328.455-.679.51a22.307,22.307,0,0,1-3.412.011c-.3-.027-.874-.232-.874-.573V25.611H4.965v3.561c0,.34-.578.546-.874.573a22.307,22.307,0,0,1-3.412-.011c-.35-.055-.472-.261-.679-.51ZM1.655,28.088H3.31V1.654H1.655Zm49.647,0v-17.6c0-.72-1.655-.72-1.655,0v17.6ZM14.894,15.7V12.759a7.516,7.516,0,0,0-.307-.726,2.737,2.737,0,0,0-1.735-1.262,35.649,35.649,0,0,0-5.461-.029A2.559,2.559,0,0,0,5.312,11.97a6,6,0,0,0-.347.789V15.7Zm33.1,4.955V14.41A2.809,2.809,0,0,0,45.769,12.4l-26.794,0a2.742,2.742,0,0,0-2.426,2.017v6.245Zm-33.1-3.3H4.965v6.607H47.992V22.307H15.463a1.286,1.286,0,0,1-.569-.568Z" fill="#fff"/>                                  </g>                                </svg>                            <?php endif; ?>                        </div>                        <strong><?php echo esc_html( $etichetta_camera ); ?></strong>                        <span><?php echo esc_html( $capacita_camera ); ?> <?php esc_html_e( 'posti disponibili', 'born-to-ride-booking' ); ?></span>                    </a>                <?php endfor; ?>            <?php endforeach; ?>        </div>        <?php        return ob_get_clean();    }    /**     * Render participants form     */    private function render_participants_form() {        // Generate room buttons HTML        $btr_room_buttons_html = $this->generate_room_buttons_html();        // Define ordinal numbers for participants        $ordinali = array(            'Primo', 'Secondo', 'Terzo', 'Quarto', 'Quinto', 'Sesto', 'Settimo', 'Ottavo', 'Nono', 'Decimo',            'Undicesimo', 'Dodicesimo', 'Tredicesimo', 'Quattordicesimo', 'Quindicesimo',            'Sedicesimo', 'Diciassettesimo', 'Diciottesimo', 'Diciannovesimo', 'Ventesimo',            'Ventunesimo', 'Ventiduesimo', 'Ventitreesimo', 'Ventiquattresimo', 'Venticinquesimo',            'Ventiseiesimo', 'Ventisettesimo', 'Ventottesimo', 'Ventinovesimo', 'Trentesimo'        );        ?>        <div id="btr-anagrafici-container">            <?php foreach ( $this->anagrafici as $index => $persona ) : ?>                <div class="btr-person-card" data-person-index="<?php echo esc_attr( $index ); ?>">                    <h3 class="person-title">                        <span class="icona-partecipante">                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5.52 19c.64-2.2 1.84-3 3.22-3h6.52c1.38 0 2.58.8 3.22 3"/><circle cx="12" cy="10" r="3"/><circle cx="12" cy="12" r="10"/></svg>                        </span>                        <?php                        $posizione = $ordinali[ $index ] ?? sprintf( __( 'Partecipante %d', 'born-to-ride-booking' ), $index + 1 );                        echo '<strong>' . esc_html( $posizione ) . '</strong> ' . esc_html__( 'partecipante', 'born-to-ride-booking' );                        ?>                    </h3>                    <div class="btr-grid">                        <?php $this->render_participant_fields( $index, $persona ); ?>                    </div>                    <div class="btr-field-group asign-camera">                        <h4><?php esc_html_e( 'A quale camera lo vuoi associare?', 'born-to-ride-booking' ); ?></h4>                        <?php echo $btr_room_buttons_html; ?>                        <!-- Hidden field to save the room ID -->                        <input type="hidden" name="anagrafici[<?php echo esc_attr( $index ); ?>][camera]" id="btr_camera_<?php echo esc_attr( $index ); ?>" value="<?php echo esc_attr( $persona['camera'] ?? '' ); ?>">                        <!-- Hidden field to save the room type -->                        <input type="hidden" name="anagrafici[<?php echo esc_attr( $index ); ?>][camera_tipo]" id="btr_camera_tipo_<?php echo esc_attr( $index ); ?>" value="<?php echo esc_attr( $persona['camera_tipo'] ?? '' ); ?>">                    </div>                    <?php $this->render_insurance_options( $index, $persona ); ?>                    <!-- Participant summary -->                    <div class="btr-person-summary">                        <h4><?php esc_html_e( 'Riepilogo dati', 'born-to-ride-booking' ); ?></h4>                        <ul class="btr-person-data-list">                            <li class="btr-person-data-item" data-field="nome">                                <strong><?php esc_html_e( 'Nome:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['nome'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="cognome">                                <strong><?php esc_html_e( 'Cognome:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['cognome'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="data_nascita">                                <strong><?php esc_html_e( 'Data di nascita:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['data_nascita'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="citta_nascita">                                <strong><?php esc_html_e( 'Città di nascita:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['citta_nascita'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="citta_residenza">                                <strong><?php esc_html_e( 'Città di residenza:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['citta_residenza'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="provincia_residenza">                                <strong><?php esc_html_e( 'Provincia di residenza:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['provincia_residenza'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="email">                                <strong><?php esc_html_e( 'Email:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['email'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="telefono">                                <strong><?php esc_html_e( 'Telefono:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['telefono'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="codice_fiscale">                                <strong><?php esc_html_e( 'Codice Fiscale:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['codice_fiscale'] ?? '' ); ?></span>                            </li>                            <li class="btr-person-data-item" data-field="camera">                                <strong><?php esc_html_e( 'Camera:', 'born-to-ride-booking' ); ?></strong>                                <span class="btr-person-data-value"><?php echo esc_html( $persona['camera_tipo'] ?? '' ); ?></span>                            </li>                            <?php if ( ! empty( $persona['assicurazioni'] ) ) : ?>                                <li class="btr-person-data-item" data-field="assicurazioni">                                    <strong><?php esc_html_e( 'Assicurazioni:', 'born-to-ride-booking' ); ?></strong>                                    <span class="btr-person-data-value">                                        <?php                                         $assicurazioni_attive = array();                                        foreach ( $persona['assicurazioni'] as $slug => $value ) {                                            if ( $value ) {                                                // Find the insurance description                                                $descrizione = $slug;                                                if ( ! empty( $this->package_data['assicurazione_importi'] ) ) {                                                    foreach ( $this->package_data['assicurazione_importi'] as $assicurazione ) {                                                        if ( sanitize_title( $assicurazione['descrizione'] ) === $slug ) {                                                            $descrizione = $assicurazione['descrizione'];                                                            break;                                                        }                                                    }                                                }                                                $assicurazioni_attive[] = $descrizione;                                            }                                        }                                        echo esc_html( implode( ', ', $assicurazioni_attive ) );                                        ?>                                    </span>                                </li>                            <?php endif; ?>                        </ul>                        <button type="button" class="btr-edit-person button"><?php esc_html_e( 'Modifica', 'born-to-ride-booking' ); ?></button>                    </div>                </div>            <?php endforeach; ?>        </div>        <?php    }    /**     * Render participant fields     *     * @param int   $index   Participant index.     * @param array $persona Participant data.     */    private function render_participant_fields( $index, $persona ) {        $fields = array(            'nome' => array(                'label' => __( 'Nome', 'born-to-ride-booking' ),                'type' => 'text',                'required' => true,            ),            'cognome' => array(                'label' => __( 'Cognome', 'born-to-ride-booking' ),                'type' => 'text',                'required' => true,            ),            'data_nascita' => array(                'label' => __( 'Data di nascita', 'born-to-ride-booking' ),                'type' => 'date',                'required' => true,            ),            'citta_nascita' => array(                'label' => __( 'Città di Nascita', 'born-to-ride-booking' ),                'type' => 'text',                'required' => true,            ),            'citta_residenza' => array(                'label' => __( 'Città di Residenza', 'born-to-ride-booking' ),                'type' => 'text',                'required' => true,            ),            'provincia_residenza' => array(                'label' => __( 'Provincia di Residenza', 'born-to-ride-booking' ),                'type' => 'text',                'required' => true,            ),            'email' => array(                'label' => __( 'Email', 'born-to-ride-booking' ),                'type' => 'email',                'required' => true,            ),            'telefono' => array(                'label' => __( 'Telefono', 'born-to-ride-booking' ),                'type' => 'tel',                'required' => true,            ),            'codice_fiscale' => array(                'label' => __( 'Codice Fiscale', 'born-to-ride-booking' ),                'type' => 'text',                'required' => false,                'class' => 'codice-fiscale-field ' . ( ( $index === 0 || ! empty( $persona['assicurazioni'] ) ) ? '' : 'hidden-field' ),            ),        );        foreach ( $fields as $field_name => $field_data ) {            ?>            <div class="btr-field-group <?php echo esc_attr( $field_data['class'] ?? '' ); ?>">                <label for="btr_<?php echo esc_attr( $field_name ); ?>_<?php echo esc_attr( $index ); ?>">                    <?php echo esc_html( $field_data['label'] ); ?>                </label>                <input                     type="<?php echo esc_attr( $field_data['type'] ); ?>"                     id="btr_<?php echo esc_attr( $field_name ); ?>_<?php echo esc_attr( $index ); ?>"                     name="anagrafici[<?php echo esc_attr( $index ); ?>][<?php echo esc_attr( $field_name ); ?>]"                     value="<?php echo esc_attr( $persona[ $field_name ] ?? '' ); ?>"                    <?php echo $field_data['required'] ? 'required' : ''; ?>                >            </div>            <?php        }    }    /**     * Render insurance options     *     * @param int   $index   Participant index.     * @param array $persona Participant data.     */    private function render_insurance_options( $index, $persona ) {        $btr_assicurazione_importi = $this->package_data['assicurazione_importi'];        if ( empty( $btr_assicurazione_importi ) ) {            return;        }        ?>        <fieldset class="btr-assicurazioni">            <h4><?php esc_html_e( 'Assicurazioni', 'born-to-ride-booking' ); ?></h4>            <p><?php esc_html_e( 'Desideri associare delle assicurazioni a questo partecipante?', 'born-to-ride-booking' ); ?></p>            <?php             foreach ( $btr_assicurazione_importi as $assicurazione_index => $assicurazione ) :                if ( empty( $assicurazione['descrizione'] ) ) {                    continue;                }                $slug = sanitize_title( $assicurazione['descrizione'] );                $is_selected = ! empty( $persona['assicurazioni'][ $slug ] );                $percentuale = $assicurazione['importo_perentuale'] ?? '';                $importo = $assicurazione['importo'] ?? '';                $product_id = 0;                $prodotti_assicurazione = $this->package_data['assicurazioni_prodotti'];                if ( ! empty( $prodotti_assicurazione ) ) {                    foreach ( $prodotti_assicurazione as $prodotto ) {                        if (                            isset( $prodotto['descrizione'] ) &&                            $prodotto['descrizione'] === $assicurazione['descrizione'] &&                            floatval( $prodotto['importo'] ) === floatval( $importo )                        ) {                            $product_id = $prodotto['id'];                            break;                        }                    }                }                ?>                <div class="btr-assicurazione-item">                    <label>                        <input type="checkbox"                               name="anagrafici[<?php echo esc_attr( $index ); ?>][assicurazioni][<?php echo esc_attr( $slug ); ?>]"                               value="1" <?php checked( $is_selected, true ); ?> />                        <?php echo esc_html( $assicurazione['descrizione'] ); ?>                        <?php if ( ! empty( $assicurazione['assicurazione_view_prezzo'] ) && $assicurazione['assicurazione_view_prezzo'] == '1' ) : ?>                            <strong><?php echo number_format_i18n( (float) $importo, 2 ); ?> €</strong>                        <?php endif; ?>                        <?php if ( ! empty( $assicurazione['assicurazione_view_percentuale'] ) && $assicurazione['assicurazione_view_percentuale'] == '1' ) : ?>                            <strong>+ <?php echo floatval( $percentuale ); ?>%</strong>                        <?php endif; ?>                    </label>                    <?php if ( ! empty( $assicurazione['descrizione_estesa'] ) ) : ?>                        <div class="btr-assicurazione-descrizione">                            <?php echo wp_kses_post( $assicurazione['descrizione_estesa'] ); ?>                        </div>                    <?php endif; ?>                    <input type="hidden" name="anagrafici[<?php echo esc_attr( $index ); ?>][assicurazioni_prodotti][<?php echo esc_attr( $slug ); ?>]" value="<?php echo esc_attr( $product_id ); ?>">                </div>            <?php endforeach; ?>        </fieldset>        <?php    }    /**     * Render checkout summary     */    private function render_checkout_summary() {        if ( ! empty( $this->remaining_time ) ) {            return;        }        ?>        <div id="btr-checkout-summary" class="btr-checkout-summary">            <div class="btr-summary-header">                <div class="wpb_wrapper ps-1">                    <h2 id="title-step" style="color: #0097c5;text-align: left; font-size: 30px; margin-bottom:0" class="vc_custom_heading vc_do_custom_heading"><?php esc_html_e( 'Riepilogo ordine', 'born-to-ride-booking' ); ?></h2>                    <p id="desc-step"><?php esc_html_e( 'Verifica i dettagli prima di procedere al checkout', 'born-to-ride-booking' ); ?></p>                </div>            </div>            <div class="btr-summary-grid">                <div class="btr-summary-card">                    <div class="btr-summary-card-header">                        <div class="btr-summary-icon">                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>                        </div>                        <h4><?php esc_html_e( 'Partecipanti', 'born-to-ride-booking' ); ?></h4>                    </div>                    <div class="btr-summary-card-body">                        <div class="btr-summary-item">                            <span class="btr-summary-label"><?php esc_html_e( 'Totale partecipanti', 'born-to-ride-booking' ); ?></span>                            <span class="btr-summary-value" id="btr-summary-total-participants"><?php echo esc_html( $this->totale_persone ); ?></span>                        </div>                        <div class="btr-summary-item">                            <span class="btr-summary-label"><?php esc_html_e( 'Partecipanti con assicurazione', 'born-to-ride-booking' ); ?></span>                            <span class="btr-summary-value" id="btr-summary-insured-participants">0</span>                        </div>                    </div>                </div>                <div class="btr-summary-card">                    <div class="btr-summary-card-header">                        <div class="btr-summary-icon">                            <svg id="Raggruppa_35" data-name="Raggruppa 35" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="45.18" height="41.607" viewBox="0 0 45.18 41.607">                                <defs>                                    <clipPath id="clip-path">                                        <rect id="Rettangolo_24" data-name="Rettangolo 24" width="45.18" height="41.607" fill="#fff"/>                                    </clipPath>                                </defs>                                <g id="Raggruppa_21" data-name="Raggruppa 21" clip-path="url(#clip-path)">                                    <path id="Tracciato_35" data-name="Tracciato 35" d="M45.18,26.337V38.578A3.621,3.621,0,0,1,38.8,40.253a4.118,4.118,0,0,1-.747-1.63V36.905H7.239v1.717a4.116,4.116,0,0,1-.747,1.63A3.621,3.621,0,0,1,.108,38.578c.255-3.952-.341-8.34,0-12.242a10.632,10.632,0,0,1,2.727-5.859l0-14.886A6.279,6.279,0,0,1,8.336,0H36.689a6.266,6.266,0,0,1,5.589,5.593V20.3a10.6,10.6,0,0,1,2.9,6.035m-4.666-7.4V5.508c0-1.625-2.33-3.8-4-3.747L8.349,1.775C6.846,1.841,4.6,3.944,4.6,5.42V19.115a5.785,5.785,0,0,1,1.838-.891c.1-1.437-.192-3,.235-4.389a4.721,4.721,0,0,1,4.041-3.267c2.873-.2,5.987.151,8.885.014a4.99,4.99,0,0,1,3.015,1.833c.193.033.383-.395.516-.521a5.129,5.129,0,0,1,2.562-1.312c2.911.156,6.094-.241,8.973-.013A4.778,4.778,0,0,1,38.64,13.9c.4,1.363.107,2.917.212,4.324ZM21.764,17.53V14.844a3.094,3.094,0,0,0-2.284-2.471c-2.785.086-5.834-.249-8.591-.043a2.883,2.883,0,0,0-2.363,1.6,7.152,7.152,0,0,0-.318.915v2.862c.542-.052,1.177-.159,1.713-.18,3.911-.152,7.923.121,11.844,0m15.317.176V14.844c0-1.228-1.507-2.426-2.681-2.514-2.739-.2-5.753.142-8.52.027a3.165,3.165,0,0,0-2.356,2.4V17.53c3.947.124,8-.164,11.932,0,.508.021,1.111.13,1.625.18M43.419,29.86V26.469a9.429,9.429,0,0,0-1.161-3.33,8.17,8.17,0,0,0-6.89-3.852c-8.314-.438-17.007.339-25.36,0-3.671-.278-8.139,3.457-8.139,7.182V29.86h23.9a1.006,1.006,0,0,1,.906.858c.025.269-.281.9-.554.9H1.869v3.523h41.55V31.621H34.308a1.278,1.278,0,0,1-.5-.463.955.955,0,0,1,.769-1.3ZM5.478,36.905H1.869v1.453c0,.03.189.489.229.564a1.85,1.85,0,0,0,3.1.127,4.973,4.973,0,0,0,.278-.6Zm37.941,0H39.81v1.541a4.973,4.973,0,0,0,.278.6,1.85,1.85,0,0,0,3.1-.127c.039-.075.229-.534.229-.564Z" transform="translate(0)" fill="#fff"/>                                    <path id="Tracciato_36" data-name="Tracciato 36" d="M250.993,255.053a.873.873,0,1,1-.873-.873.873.873,0,0,1,.873.873" transform="translate(-219.922 -224.274)" fill="currentColor"/>                                </g>                            </svg>                        </div>                        <h4><?php esc_html_e( 'Camere', 'born-to-ride-booking' ); ?></h4>                    </div>                    <div class="btr-summary-card-body">                        <div id="btr-summary-rooms-list">                            <?php foreach ( $this->camere_acquistate as $camera_id => $camera ) : ?>                                <div class="btr-summary-item">                                    <span class="btr-summary-label"><?php echo esc_html( $camera['tipo'] ); ?></span>                                    <span class="btr-summary-value"><?php echo esc_html( $camera['quantita'] ); ?> × <?php echo esc_html( $camera['capacita'] ); ?> <?php esc_html_e( 'posti', 'born-to-ride-booking' ); ?></span>                                </div>                            <?php endforeach; ?>                        </div>                        <div class="btr-summary-item btr-summary-total">                            <span class="btr-summary-label"><?php esc_html_e( 'Totale camere', 'born-to-ride-booking' ); ?></span>                            <span class="btr-summary-value" id="btr-summary-total-rooms"><?php echo esc_html( array_sum( array_column( $this->camere_acquistate, 'quantita' ) ) ); ?></span>                        </div>                    </div>                </div>                <div class="btr-summary-card">                    <div class="btr-summary-card-header">                        <div class="btr-summary-icon">                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>                        </div>                        <h4><?php esc_html_e( 'Assicurazioni', 'born-to-ride-booking' ); ?></h4>                    </div>                    <div class="btr-summary-card-body">                        <div id="btr-summary-insurance-list">                            <!-- This will be populated by JavaScript -->                        </div>                        <div class="btr-summary-item btr-summary-total">                            <span class="btr-summary-label"><?php esc_html_e( 'Totale assicurazioni', 'born-to-ride-booking' ); ?></span>                            <span class="btr-summary-value" id="btr-summary-total-insurance">0</span>                        </div>                    </div>                </div>            </div>            <div class="btr-summary-footer">                <div class="btr-summary-price">                    <span class="btr-summary-price-label"><?php esc_html_e( 'Prezzo totale', 'born-to-ride-booking' ); ?></span>                    <span class="btr-summary-price-value">                        <span id="btr-summary-total-price"><?php echo number_format_i18n( (float) $this->package_data['prezzo_totale'], 2 ); ?></span> €                    </span>                </div>            </div>        </div>        <?php    }    /**     * Render form end     */    private function render_form_end() {        ?>        <div class="btr-form-actions">            <?php if ( empty( $this->remaining_time ) ) : ?>                <button type="submit" class="btr-submit-button button button-primary button-large">                    <?php esc_html_e( 'Procedi al checkout', 'born-to-ride-booking' ); ?>                </button>            <?php else : ?>                <button type="button" id="btr-save-anagrafici" class="btr-submit-button button button-primary button-large">                    <?php esc_html_e( 'Salva dati', 'born-to-ride-booking' ); ?>                </button>            <?php endif; ?>        </div>        </form>        <?php    }}// Make sure required variables are defined// These variables should be passed to the template from the calling codeif ( ! isset( $order_id ) ) {    $order_id = 0;}if ( ! isset( $preventivo_id ) ) {    $preventivo_id = 0;}if ( ! isset( $anagrafici ) ) {    $anagrafici = array();}if ( ! isset( $totale_persone ) ) {    $totale_persone = 0;}if ( ! isset( $remaining_time ) ) {    $remaining_time = 0;}if ( ! isset( $camere_acquistate ) ) {    $camere_acquistate = array();}// Initialize and render the form$form = new BTR_Form_Anagrafici( $order_id, $preventivo_id, $anagrafici, $totale_persone, $remaining_time, $camere_acquistate );$form->render();